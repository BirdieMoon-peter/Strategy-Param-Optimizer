# é€šç”¨ç­–ç•¥ä¼˜åŒ–å™¨ - å¿«é€Ÿå¼€å§‹

## ğŸ¯ 5åˆ†é’Ÿä¸Šæ‰‹æŒ‡å—

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡æ•°æ®æ–‡ä»¶

åˆ›å»ºæˆ–ä½¿ç”¨ç°æœ‰çš„CSVæ ¼å¼æ•°æ®æ–‡ä»¶ï¼Œå¿…é¡»åŒ…å«ä»¥ä¸‹åˆ—ï¼š

```csv
datetime,open,high,low,close,volume
2024-01-01 00:00:00,42000,42500,41800,42300,1000000
2024-01-01 01:00:00,42300,42800,42200,42700,950000
...
```

**æ•°æ®è¦æ±‚ï¼š**
- `datetime`: æ—¶é—´æˆ³ï¼ˆå­—ç¬¦ä¸²æˆ–æ—¶é—´æ ¼å¼ï¼‰
- `open, high, low, close`: ä»·æ ¼æ•°æ®ï¼ˆæ•°å€¼ï¼‰
- `volume`: æˆäº¤é‡ï¼ˆæ•°å€¼ï¼‰

### ç¬¬äºŒæ­¥ï¼šç¼–å†™ç­–ç•¥

åˆ›å»ºä¸€ä¸ªPythonæ–‡ä»¶ï¼Œä¾‹å¦‚ `my_strategy.py`ï¼š

```python
import backtrader as bt

class MyStrategy(bt.Strategy):
    """æˆ‘çš„äº¤æ˜“ç­–ç•¥"""
    
    # 1. å®šä¹‰å‚æ•°ï¼ˆè¿™äº›å‚æ•°ä¼šè¢«è‡ªåŠ¨ä¼˜åŒ–ï¼‰
    params = (
        ('fast_period', 10),  # å¿«é€Ÿå‡çº¿å‘¨æœŸ
        ('slow_period', 30),  # æ…¢é€Ÿå‡çº¿å‘¨æœŸ
    )
    
    # 2. åˆå§‹åŒ–æŒ‡æ ‡
    def __init__(self):
        self.fast_ma = bt.indicators.SMA(self.data.close, period=self.params.fast_period)
        self.slow_ma = bt.indicators.SMA(self.data.close, period=self.params.slow_period)
        self.crossover = bt.indicators.CrossOver(self.fast_ma, self.slow_ma)
    
    # 3. äº¤æ˜“é€»è¾‘
    def next(self):
        if not self.position:  # æ— æŒä»“
            if self.crossover > 0:  # é‡‘å‰ - ä¹°å…¥
                self.buy()
        else:  # æœ‰æŒä»“
            if self.crossover < 0:  # æ­»å‰ - å–å‡º
                self.sell()
```

**ç­–ç•¥è¦ç‚¹ï¼š**
- å¿…é¡»ç»§æ‰¿ `backtrader.Strategy`
- åœ¨ `params` å…ƒç»„ä¸­å®šä¹‰æ‰€æœ‰éœ€è¦ä¼˜åŒ–çš„å‚æ•°
- `__init__` ä¸­åˆå§‹åŒ–æŒ‡æ ‡
- `next` ä¸­å®ç°äº¤æ˜“é€»è¾‘

### ç¬¬ä¸‰æ­¥ï¼šè¿è¡Œä¼˜åŒ–

#### æ–¹æ³•1ï¼šä½¿ç”¨Pythonè„šæœ¬

```python
from universal_optimizer import UniversalOptimizer

# åˆ›å»ºä¼˜åŒ–å™¨
optimizer = UniversalOptimizer(
    data_path="data/BTC.csv",           # æ•°æ®æ–‡ä»¶
    strategy_path="my_strategy.py",     # ç­–ç•¥æ–‡ä»¶
    objective="sharpe_ratio",           # ä¼˜åŒ–ç›®æ ‡
    use_llm=False,                      # æš‚ä¸ä½¿ç”¨LLM
    output_dir="./results",             # ç»“æœä¿å­˜ç›®å½•
    verbose=True                        # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
)

# æ‰§è¡Œä¼˜åŒ–ï¼ˆ50æ¬¡è¯•éªŒï¼‰
result = optimizer.optimize(n_trials=50)

print("ä¼˜åŒ–å®Œæˆï¼")
```

#### æ–¹æ³•2ï¼šä½¿ç”¨å‘½ä»¤è¡Œ

```bash
# æ¿€æ´»condaç¯å¢ƒ
conda activate quant

# è¿è¡Œä¼˜åŒ–
python run_universal_optimizer.py \
    --data data/BTC.csv \
    --strategy my_strategy.py \
    --objective sharpe_ratio \
    --trials 50
```

### ç¬¬å››æ­¥ï¼šæŸ¥çœ‹ç»“æœ

ä¼˜åŒ–å®Œæˆåï¼Œä¼šåœ¨è¾“å‡ºç›®å½•ç”ŸæˆJSONæ–‡ä»¶ï¼ŒåŒ…å«ï¼š

```json
{
  "optimization_info": {
    "asset_name": "BTC",
    "strategy_name": "MyStrategy",
    "optimization_objective": "sharpe_ratio",
    ...
  },
  "best_parameters": {
    "fast_period": 12,
    "slow_period": 26
  },
  "performance_metrics": {
    "sharpe_ratio": 1.85,
    "annual_return": 35.2,
    "max_drawdown": -12.5,
    ...
  },
  "llm_explanation": {
    "parameter_explanation": "...",
    "performance_analysis": "...",
    ...
  }
}
```

---

## ğŸš€ è¿›é˜¶ç”¨æ³•

### ä½¿ç”¨LLMè¾…åŠ©ä¼˜åŒ–

LLMå¯ä»¥å¸®åŠ©ï¼š
- æ™ºèƒ½æ¨èå‚æ•°æœç´¢èŒƒå›´
- åˆ†æä¼˜åŒ–ç»“æœå¹¶æä¾›è§£é‡Š
- ç»™å‡ºå®æˆ˜åº”ç”¨å»ºè®®

#### ä½¿ç”¨OpenAI API

```python
from universal_llm_client import UniversalLLMConfig

# é…ç½®OpenAI
llm_config = UniversalLLMConfig(
    api_type="openai",
    base_url="https://api.openai.com/v1",
    model_name="gpt-4",
    api_key="sk-your-api-key-here"  # æ›¿æ¢ä¸ºä½ çš„APIå¯†é’¥
)

# åˆ›å»ºä¼˜åŒ–å™¨ï¼ˆå¯ç”¨LLMï¼‰
optimizer = UniversalOptimizer(
    data_path="data/BTC.csv",
    strategy_path="my_strategy.py",
    objective="sharpe_ratio",
    use_llm=True,              # å¯ç”¨LLM
    llm_config=llm_config,     # LLMé…ç½®
    output_dir="./results"
)

result = optimizer.optimize(n_trials=50)
```

#### ä½¿ç”¨æœ¬åœ°Ollama

```python
llm_config = UniversalLLMConfig(
    api_type="ollama",
    base_url="http://localhost:11434",
    model_name="qwen",  # æˆ–å…¶ä»–å·²å®‰è£…çš„æ¨¡å‹
    api_key=""          # Ollamaä¸éœ€è¦APIå¯†é’¥
)
```

**å‘½ä»¤è¡Œæ–¹å¼ï¼š**

```bash
# ä½¿ç”¨OpenAI
python run_universal_optimizer.py \
    --data data/BTC.csv \
    --strategy my_strategy.py \
    --use-llm \
    --llm-type openai \
    --llm-model gpt-4 \
    --api-key sk-xxx

# ä½¿ç”¨Ollama
python run_universal_optimizer.py \
    --data data/BTC.csv \
    --strategy my_strategy.py \
    --use-llm \
    --llm-type ollama \
    --llm-model qwen
```

### æ‰¹é‡ä¼˜åŒ–å¤šä¸ªç›®æ ‡

```python
# åŒæ—¶ä¼˜åŒ–å¤šä¸ªç›®æ ‡
result = optimizer.batch_optimize(
    objectives=["sharpe_ratio", "annual_return", "calmar_ratio"],
    n_trials_per_objective=50
)
```

**å‘½ä»¤è¡Œæ–¹å¼ï¼š**

```bash
python run_universal_optimizer.py \
    --data data/BTC.csv \
    --strategy my_strategy.py \
    --batch \
    --objectives sharpe_ratio annual_return calmar_ratio \
    --trials 50
```

---

## ğŸ“Š ä¼˜åŒ–ç›®æ ‡è¯´æ˜

| ç›®æ ‡ | å«ä¹‰ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `sharpe_ratio` | å¤æ™®æ¯”ç‡ | è¿½æ±‚é£é™©è°ƒæ•´åæ”¶ç›Šï¼Œæ¨è |
| `annual_return` | å¹´åŒ–æ”¶ç›Šç‡ | è¿½æ±‚é«˜æ”¶ç›Š |
| `calmar_ratio` | å¡ç›æ¯”ç‡ | æ”¶ç›Š/æœ€å¤§å›æ’¤ï¼Œå¹³è¡¡æ”¶ç›Šä¸é£é™© |
| `sortino_ratio` | ç´¢æè¯ºæ¯”ç‡ | å…³æ³¨ä¸‹è¡Œé£é™© |
| `max_drawdown` | æœ€å¤§å›æ’¤ | é£é™©æ§åˆ¶ä¼˜å…ˆ |
| `total_return` | æ€»æ”¶ç›Šç‡ | ç®€å•æ”¶ç›Šæœ€å¤§åŒ– |

**å»ºè®®ï¼š**
- æ–°æ‰‹ï¼šä½¿ç”¨ `sharpe_ratio`
- ç¨³å¥å‹ï¼šä½¿ç”¨ `calmar_ratio`
- æ¿€è¿›å‹ï¼šä½¿ç”¨ `annual_return`

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q: ä¼˜åŒ–éœ€è¦å¤šå°‘æ¬¡è¯•éªŒï¼Ÿ

**A:** æ ¹æ®å‚æ•°æ•°é‡å†³å®šï¼š
- 2-3ä¸ªå‚æ•°ï¼š30-50æ¬¡
- 4-6ä¸ªå‚æ•°ï¼š50-100æ¬¡
- 7+ä¸ªå‚æ•°ï¼š100-200æ¬¡

### Q: å¿…é¡»ä½¿ç”¨LLMå—ï¼Ÿ

**A:** ä¸å¿…é¡»ã€‚
- **ä¸ä½¿ç”¨LLM**ï¼šæ›´å¿«ï¼Œé€‚åˆå¿«é€Ÿæµ‹è¯•
- **ä½¿ç”¨LLM**ï¼šæ›´æ™ºèƒ½ï¼Œå¯èƒ½æ‰¾åˆ°æ›´å¥½çš„å‚æ•°ï¼Œæä¾›è¯¦ç»†è§£é‡Š

### Q: å¦‚ä½•é¿å…è¿‡æ‹Ÿåˆï¼Ÿ

**A:** å»ºè®®ï¼š
1. ä¿ç•™æ ·æœ¬å¤–æ•°æ®éªŒè¯
2. ä¸è¦è¿‡åº¦ä¼˜åŒ–ï¼ˆå‡å°‘è¯•éªŒæ¬¡æ•°ï¼‰
3. å…³æ³¨ç­–ç•¥é€»è¾‘çš„åˆç†æ€§
4. æŸ¥çœ‹LLMçš„é£é™©è¯„ä¼°

### Q: æ•°æ®æ ¼å¼é”™è¯¯æ€ä¹ˆåŠï¼Ÿ

**A:** ç¡®ä¿CSVæ–‡ä»¶ï¼š
- åŒ…å«å¿…éœ€çš„åˆ—ï¼ˆdatetime, open, high, low, close, volumeï¼‰
- åˆ—åå®Œå…¨åŒ¹é…ï¼ˆå°å†™ï¼‰
- æ²¡æœ‰ç¼ºå¤±å€¼
- datetimeæ ¼å¼æ­£ç¡®

### Q: LLMè¿æ¥å¤±è´¥ï¼Ÿ

**A:** æ£€æŸ¥ï¼š
1. APIå¯†é’¥æ˜¯å¦æ­£ç¡®
2. ç½‘ç»œæ˜¯å¦æ­£å¸¸
3. å¯¹äºOllamaï¼Œç¡®ä¿æœåŠ¡å·²å¯åŠ¨ï¼š`ollama serve`
4. å¯ä»¥å…ˆç”¨ `--no-llm` æµ‹è¯•åŸºæœ¬åŠŸèƒ½

---

## ğŸ“š ç¤ºä¾‹ç­–ç•¥

é¡¹ç›®æä¾›äº†å¤šä¸ªç¤ºä¾‹ç­–ç•¥ï¼ˆ`example_strategy.py`ï¼‰ï¼š

1. **SimpleMAStrategy** - åŒå‡çº¿äº¤å‰ç­–ç•¥
2. **RSIStrategy** - RSIè¶…ä¹°è¶…å–ç­–ç•¥
3. **BollingerBandsStrategy** - å¸ƒæ—å¸¦çªç ´ç­–ç•¥
4. **MACDStrategy** - MACDç­–ç•¥

ä½ å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›ç­–ç•¥è¿›è¡Œæµ‹è¯•ï¼š

```bash
python run_universal_optimizer.py \
    --data data/BTC.csv \
    --strategy example_strategy.py \
    --trials 50
```

---

## ğŸ› ï¸ æµ‹è¯•å®‰è£…

è¿è¡Œæµ‹è¯•è„šæœ¬ç¡®ä¿ä¸€åˆ‡æ­£å¸¸ï¼š

```bash
cd /Users/peter/Desktop/é‡åŒ–/project_trend
conda activate quant
python Optimizer/test_universal_optimizer.py
```

---

## ğŸ“– å®Œæ•´æ–‡æ¡£

è¯¦ç»†æ–‡æ¡£è¯·å‚é˜…ï¼š
- **UNIVERSAL_OPTIMIZER_GUIDE.md** - å®Œæ•´ä½¿ç”¨æŒ‡å—
- **example_strategy.py** - ç­–ç•¥ç¼–å†™ç¤ºä¾‹å’ŒæŒ‡å—

---

## ğŸ“ å­¦ä¹ è·¯å¾„

1. **å…¥é—¨**ï¼šä½¿ç”¨ç¤ºä¾‹æ•°æ®å’Œç¤ºä¾‹ç­–ç•¥ï¼Œä¸å¯ç”¨LLM
2. **è¿›é˜¶**ï¼šç¼–å†™è‡ªå·±çš„ç­–ç•¥ï¼Œæµ‹è¯•ä¸åŒä¼˜åŒ–ç›®æ ‡
3. **é«˜çº§**ï¼šå¯ç”¨LLMï¼Œæ‰¹é‡ä¼˜åŒ–ï¼Œæ ·æœ¬å¤–éªŒè¯

---

**å¼€å§‹ä½ çš„é‡åŒ–äº¤æ˜“ä¹‹æ—…ï¼** ğŸš€

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒå®Œæ•´æ–‡æ¡£æˆ–æ£€æŸ¥æµ‹è¯•è„šæœ¬ã€‚
