# Optimizer 项目总览

## 🎯 项目结构

```
Optimizer/
├── 📦 核心模块
│   ├── universal_optimizer.py          ⭐ 通用优化器（主类）
│   ├── universal_llm_client.py         ⭐ 通用LLM客户端
│   ├── backtest_engine.py              回测引擎
│   ├── bayesian_optimizer.py           贝叶斯优化器
│   ├── strategy_analyzer.py            策略分析器
│   ├── report_generator.py             报告生成器
│   └── config.py                       配置文件
│
├── 🚀 入口文件
│   ├── run_universal_optimizer.py      ⭐ 命令行入口
│   ├── quick_start.sh                  ⭐ 快速启动脚本
│   └── main.py                         原始入口（兼容旧版）
│
├── 📚 示例和测试
│   ├── example_strategy.py             ⭐ 策略示例集合
│   ├── 使用示例.py                     ⭐ 6个完整示例
│   ├── test_universal_optimizer.py     ⭐ 测试套件
│   ├── config_example.py               配置示例
│   ├── test_csv_output.py              CSV测试
│   └── simple_test.py                  简单测试
│
├── 📖 中文文档
│   ├── 快速开始.md                     ⭐ 5分钟入门（推荐）
│   ├── 封装完成说明.md                 ⭐ 封装总结
│   ├── 项目总览.md                     本文件
│   ├── 运行指南.md                     运行说明
│   ├── 修改完成说明.md                 历史修改
│   └── 批量比较功能说明.md             批量比较
│
├── 📖 英文文档
│   ├── UNIVERSAL_OPTIMIZER_GUIDE.md    ⭐ 完整手册
│   ├── README_UNIVERSAL.md             ⭐ 项目说明
│   ├── README.md                       原始说明
│   ├── QUICK_START.md                  快速开始
│   ├── CHANGES.md                      变更日志
│   ├── CSV_OUTPUT_GUIDE.md             CSV指南
│   ├── BATCH_COMPARE_GUIDE.md          批量比较
│   ├── Modelfile_Guide.md              Modelfile说明
│   └── Modelfile                       Ollama配置
│
└── 📁 其他
    ├── batch_compare.py                批量比较脚本
    ├── llm_client.py                   原始LLM客户端
    ├── requirements.txt                依赖列表
    ├── output/                         输出目录
    └── reports/                        报告目录
```

---

## 🌟 核心功能

### 1. 通用策略优化器 (`universal_optimizer.py`)

**功能特点:**
- ✅ 支持任意CSV数据文件
- ✅ 动态加载策略脚本
- ✅ 多种优化目标
- ✅ 可选LLM辅助
- ✅ JSON格式输出
- ✅ 批量优化支持

**使用方式:**

```python
from universal_optimizer import UniversalOptimizer

optimizer = UniversalOptimizer(
    data_path="data/BTC.csv",
    strategy_path="my_strategy.py",
    objective="sharpe_ratio",
    use_llm=False
)

result = optimizer.optimize(n_trials=50)
```

### 2. 通用LLM客户端 (`universal_llm_client.py`)

**支持的API:**
- OpenAI (GPT-4, GPT-3.5)
- Ollama (本地模型)
- 自定义API

**内置Prompt:**
- 策略参数分析
- 优化历史分析
- 结果解释生成

**使用方式:**

```python
from universal_llm_client import UniversalLLMConfig

llm_config = UniversalLLMConfig(
    api_type="openai",
    base_url="https://api.openai.com/v1",
    model_name="gpt-4",
    api_key="sk-your-key"
)
```

### 3. 命令行工具 (`run_universal_optimizer.py`)

**功能:**
- 完整的命令行接口
- 支持所有参数配置
- 批量优化支持
- 详细帮助信息

**使用方式:**

```bash
# 基本用法
python run_universal_optimizer.py \
    --data data/BTC.csv \
    --strategy my_strategy.py \
    --trials 50

# 使用LLM
python run_universal_optimizer.py \
    --data data/BTC.csv \
    --strategy my_strategy.py \
    --use-llm \
    --llm-type openai \
    --llm-model gpt-4 \
    --api-key sk-xxx

# 批量优化
python run_universal_optimizer.py \
    --data data/BTC.csv \
    --strategy my_strategy.py \
    --batch \
    --objectives sharpe_ratio annual_return
```

---

## 📖 文档导航

### 新手入门

1. **快速开始.md** ⭐
   - 5分钟快速上手
   - 中文说明
   - 适合所有人

2. **README_UNIVERSAL.md**
   - 项目概览
   - 功能介绍
   - 示例代码

### 深入使用

3. **UNIVERSAL_OPTIMIZER_GUIDE.md**
   - 完整使用手册
   - 详细API文档
   - 高级功能
   - 常见问题

4. **example_strategy.py**
   - 4个示例策略
   - 策略编写指南
   - 丰富注释

### 实践示例

5. **使用示例.py**
   - 6个完整示例
   - 交互式选择
   - 涵盖各种场景

6. **config_example.py**
   - 配置示例
   - 开箱即用

### 参考文档

7. **封装完成说明.md**
   - 封装总结
   - 文件清单
   - 使用方法

8. **运行指南.md**
   - 详细运行说明
   - 问题排查

---

## 🚀 快速开始

### 方式1: 交互式启动脚本

```bash
cd /Users/peter/Desktop/量化/project_trend/Optimizer
./quick_start.sh
```

选择选项：
- 1 = 运行测试（验证安装）
- 2 = 运行示例（交互式学习）
- 3 = 开始优化（实际使用）

### 方式2: Python脚本

```python
# 创建文件: my_optimization.py
from universal_optimizer import UniversalOptimizer

optimizer = UniversalOptimizer(
    data_path="data/BTC.csv",
    strategy_path="example_strategy.py",
    objective="sharpe_ratio",
    use_llm=False
)

result = optimizer.optimize(n_trials=50)
print("最优参数:", result['best_parameters'])
```

```bash
python my_optimization.py
```

### 方式3: 命令行

```bash
python run_universal_optimizer.py \
    --data data/BTC.csv \
    --strategy example_strategy.py \
    --trials 50
```

---

## 📊 输入输出

### 输入要求

#### 1. 数据文件 (CSV)

必须包含列：`datetime, open, high, low, close, volume`

```csv
datetime,open,high,low,close,volume
2024-01-01 00:00:00,42000,42500,41800,42300,1000000
```

#### 2. 策略文件 (Python)

```python
import backtrader as bt

class MyStrategy(bt.Strategy):
    params = (
        ('period', 20),
    )
    
    def __init__(self):
        self.ma = bt.indicators.SMA(self.data.close, period=self.params.period)
    
    def next(self):
        if not self.position and self.data.close > self.ma:
            self.buy()
        elif self.position and self.data.close < self.ma:
            self.sell()
```

### 输出格式 (JSON)

```json
{
  "optimization_info": {...},
  "best_parameters": {...},
  "performance_metrics": {
    "sharpe_ratio": 1.85,
    "annual_return": 35.2,
    "max_drawdown": -12.5,
    ...
  },
  "yearly_performance": {...},
  "llm_explanation": {...}
}
```

---

## 🎓 学习路径

### 第1步: 环境验证

```bash
cd /Users/peter/Desktop/量化/project_trend
conda activate quant
python Optimizer/test_universal_optimizer.py
```

### 第2步: 运行示例

```bash
python Optimizer/使用示例.py
# 选择示例1（基本优化）
```

### 第3步: 阅读文档

1. **快速开始.md** - 了解基本用法
2. **example_strategy.py** - 学习策略编写
3. **UNIVERSAL_OPTIMIZER_GUIDE.md** - 深入学习

### 第4步: 实际应用

1. 准备自己的数据文件
2. 编写或使用示例策略
3. 不启用LLM先测试
4. 启用LLM查看分析
5. 批量优化比较结果

### 第5步: 高级功能

1. 样本外验证
2. Walk-Forward分析
3. 多策略组合
4. 自定义LLM Prompt

---

## 🛠️ 技术栈

- **回测引擎**: Backtrader
- **优化算法**: Optuna (贝叶斯优化)
- **LLM集成**: OpenAI API / Ollama
- **数据处理**: Pandas, NumPy
- **输出格式**: JSON

---

## 📋 完整功能清单

### ✅ 已实现功能

- [x] 通用数据加载（CSV）
- [x] 动态策略加载
- [x] 多种优化目标
- [x] 贝叶斯优化
- [x] LLM参数推荐
- [x] LLM结果解释
- [x] JSON输出
- [x] 批量优化
- [x] 逐年性能分析
- [x] 命令行界面
- [x] 完整文档
- [x] 测试套件
- [x] 示例代码
- [x] 配置模板

### 🎯 支持的优化目标

- [x] sharpe_ratio - 夏普比率
- [x] annual_return - 年化收益率
- [x] calmar_ratio - 卡玛比率
- [x] sortino_ratio - 索提诺比率
- [x] max_drawdown - 最大回撤
- [x] total_return - 总收益率

### 🤖 支持的LLM

- [x] OpenAI GPT-4
- [x] OpenAI GPT-3.5
- [x] Ollama (所有本地模型)
- [x] 自定义API

---

## 🔧 依赖管理

### 已有依赖

```
backtrader
pandas
numpy
optuna
requests
```

### 安装方式

```bash
conda activate quant
# 依赖已在环境中，无需额外安装
```

---

## 📞 使用支持

### 问题排查顺序

1. **查看文档**
   - 快速开始.md
   - UNIVERSAL_OPTIMIZER_GUIDE.md

2. **运行测试**
   ```bash
   python test_universal_optimizer.py
   ```

3. **查看示例**
   ```bash
   python 使用示例.py
   ```

4. **检查日志**
   设置 `verbose=True` 查看详细输出

### 常见问题

**Q: 数据格式错误？**
- 确保CSV包含必需列
- 列名必须小写
- datetime格式正确

**Q: LLM连接失败？**
- 检查API密钥
- 确认网络连接
- Ollama需启动服务

**Q: 优化时间太长？**
- 减少试验次数
- 不使用LLM
- 减少参数数量

**Q: 结果过拟合？**
- 保留样本外数据
- 减少优化强度
- 参考LLM风险评估

---

## 📈 性能建议

### 试验次数建议

- 2-3个参数：30-50次
- 4-6个参数：50-100次
- 7+个参数：100-200次

### 优化目标选择

- **稳健型**: sharpe_ratio 或 calmar_ratio
- **激进型**: annual_return
- **风险厌恶**: 最小化 max_drawdown

### LLM使用建议

- **快速测试**: 不使用LLM
- **深入分析**: 使用GPT-4
- **本地私密**: 使用Ollama

---

## 🎉 开始使用

### 1分钟体验

```bash
# 进入目录
cd /Users/peter/Desktop/量化/project_trend/Optimizer

# 激活环境
conda activate quant

# 运行示例
python 使用示例.py
# 选择示例1
```

### 5分钟入门

阅读 **快速开始.md**

### 深入学习

阅读 **UNIVERSAL_OPTIMIZER_GUIDE.md**

---

## 📄 版本信息

- **版本**: v1.0.0
- **状态**: ✅ 生产就绪
- **发布日期**: 2024年1月
- **Python**: 3.8+
- **许可**: MIT

---

## 🙏 致谢

感谢以下开源项目：
- Backtrader
- Optuna
- OpenAI
- Ollama

---

<div align="center">

**🚀 开始你的量化交易优化之旅！**

[快速开始](./快速开始.md) • [完整手册](./UNIVERSAL_OPTIMIZER_GUIDE.md) • [运行测试](#1分钟体验)

</div>
